<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶ä Fox Eye Guard</title>
    <meta name="theme-color" content="#1a237e">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶ä</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(26, 35, 126, 0.3);
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .guard-id {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 5px;
            display: inline-block;
        }
        
        .status-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .status-label {
            color: #666;
            font-weight: 500;
        }
        
        .status-value {
            font-weight: 600;
            color: #1a237e;
        }
        
        .battery-high { color: #4caf50; }
        .battery-medium { color: #ff9800; }
        .battery-low { color: #f44336; }
        
        .sos-button {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 25px;
            font-size: 22px;
            font-weight: bold;
            width: 100%;
            margin: 20px 0;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255,0,0,0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .sos-button:active {
            transform: scale(0.98);
            box-shadow: 0 5px 10px rgba(255,0,0,0.3);
        }
        
        .location-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .gps-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .gps-active {
            width: 12px;
            height: 12px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .coordinates {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .update-button {
            background: #1a237e;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .last-update {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #666;
            text-decoration: none;
            font-size: 12px;
        }
        
        .nav-item.active {
            color: #1a237e;
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        #loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü¶ä Fox Eye Security</h1>
            <div class="guard-id">Guard ID: <span id="guardId">Loading...</span></div>
        </header>
        
        <div id="loading">Loading guard information...</div>
        
        <div id="app" class="hidden">
            <div class="status-card">
                <h2 style="color: #1a237e; margin-bottom: 20px;">üìç Current Status</h2>
                
                <div class="status-item">
                    <span class="status-label">Guard Name</span>
                    <span class="status-value" id="guardName">-</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Site/Post</span>
                    <span class="status-value" id="guardSite">-</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Battery Level</span>
                    <span class="status-value">
                        <span id="batteryLevel">-</span>%
                        <span id="batteryIcon" class="battery-high">üîã</span>
                    </span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">GPS Accuracy</span>
                    <span class="status-value" id="gpsAccuracy">-</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Connection</span>
                    <span class="status-value" id="connectionStatus">üü¢ Online</span>
                </div>
            </div>
            
            <button class="sos-button" id="sosBtn">
                üö® SOS EMERGENCY
            </button>
            
            <div class="location-section">
                <div class="gps-status">
                    <div class="gps-active"></div>
                    <span>GPS Tracking Active</span>
                </div>
                
                <div class="coordinates">
                    <div>Latitude: <span id="latitude">-</span></div>
                    <div>Longitude: <span id="longitude">-</span></div>
                    <div>Last Update: <span id="lastUpdateTime">-</span></div>
                </div>
                
                <button class="update-button" id="updateLocationBtn">
                    üìç Update My Location
                </button>
                
                <div class="last-update">
                    Auto-update every 30 seconds
                </div>
            </div>
        </div>
    </div>
    
    <div class="nav-bar">
        <a href="#" class="nav-item active">
            <span class="nav-icon">üìç</span>
            <span>Tracking</span>
        </a>
        <a href="#" class="nav-item">
            <span class="nav-icon">üìã</span>
            <span>Duty</span>
        </a>
        <a href="#" class="nav-item">
            <span class="nav-icon">üëÆ</span>
            <span>Profile</span>
        </a>
        <a href="#" class="nav-item">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Settings</span>
        </a>
    </div>

    <script>
        // Configuration
        const SERVER_URL = 'https://tracker2-6w8m.onrender.com';
        const GUARD_ID = 'guard001'; // This should come from login
        const UPDATE_INTERVAL = 30000; // 30 seconds
        
        // DOM Elements
        const app = document.getElementById('app');
        const loading = document.getElementById('loading');
        const sosBtn = document.getElementById('sosBtn');
        const updateBtn = document.getElementById('updateLocationBtn');
        
        // Guard info elements
        const guardIdEl = document.getElementById('guardId');
        const guardNameEl = document.getElementById('guardName');
        const guardSiteEl = document.getElementById('guardSite');
        const batteryLevelEl = document.getElementById('batteryLevel');
        const batteryIconEl = document.getElementById('batteryIcon');
        const gpsAccuracyEl = document.getElementById('gpsAccuracy');
        const latitudeEl = document.getElementById('latitude');
        const longitudeEl = document.getElementById('longitude');
        const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
        
        let currentLocation = null;
        let updateInterval;
        
        // Initialize
        async function init() {
            guardIdEl.textContent = GUARD_ID;
            
            // Load guard profile
            await loadGuardProfile();
            
            // Start location tracking
            startLocationTracking();
            
            // Show app
            loading.classList.add('hidden');
            app.classList.remove('hidden');
        }
        
        async function loadGuardProfile() {
            try {
                const response = await fetch(`${SERVER_URL}/api/location/${GUARD_ID}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.location) {
                        updateGuardInfo(data.location);
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        function updateGuardInfo(guardData) {
            guardNameEl.textContent = guardData.name || 'Unknown';
            guardSiteEl.textContent = guardData.site || 'On Duty';
            batteryLevelEl.textContent = guardData.battery || '--';
            
            // Update battery icon color
            const battery = guardData.battery || 100;
            if (battery > 70) {
                batteryIconEl.className = 'battery-high';
            } else if (battery > 30) {
                batteryIconEl.className = 'battery-medium';
            } else {
                batteryIconEl.className = 'battery-low';
            }
            
            gpsAccuracyEl.textContent = guardData.accuracy ? `${guardData.accuracy}m` : 'Unknown';
            
            if (guardData.latitude && guardData.longitude) {
                latitudeEl.textContent = guardData.latitude.toFixed(6);
                longitudeEl.textContent = guardData.longitude.toFixed(6);
                currentLocation = {
                    lat: guardData.latitude,
                    lng: guardData.longitude
                };
            }
            
            if (guardData.lastUpdate) {
                const time = new Date(guardData.lastUpdate);
                lastUpdateTimeEl.textContent = time.toLocaleTimeString();
            }
        }
        
        function startLocationTracking() {
            // Immediate update
            updateLocation();
            
            // Set up interval
            updateInterval = setInterval(updateLocation, UPDATE_INTERVAL);
            
            // Also update on button click
            updateBtn.addEventListener('click', updateLocation);
        }
        
        async function updateLocation() {
            try {
                // Get current location from browser
                const position = await getCurrentPosition();
                
                // Get battery info if available
                const battery = await getBatteryLevel();
                
                // Prepare data
                const locationData = {
                    guardId: GUARD_ID,
                    guardName: guardNameEl.textContent,
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: Math.round(position.coords.accuracy),
                    battery: battery,
                    speed: position.coords.speed || 0,
                    heading: position.coords.heading || null,
                    site: guardSiteEl.textContent
                };
                
                // Update UI
                latitudeEl.textContent = position.coords.latitude.toFixed(6);
                longitudeEl.textContent = position.coords.longitude.toFixed(6);
                gpsAccuracyEl.textContent = `${Math.round(position.coords.accuracy)}m`;
                batteryLevelEl.textContent = battery;
                lastUpdateTimeEl.textContent = new Date().toLocaleTimeString();
                
                // Send to server
                const response = await fetch(`${SERVER_URL}/api/location`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(locationData)
                });
                
                const result = await response.json();
                console.log('Location updated:', result);
                
                // Update current location
                currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
            } catch (error) {
                console.error('Error updating location:', error);
                alert('Unable to get location. Please enable GPS.');
            }
        }
        
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }
        
        async function getBatteryLevel() {
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    return Math.round(battery.level * 100);
                } catch (error) {
                    return 100; // Default
                }
            }
            return 100; // Default
        }
        
        // SOS Button
        sosBtn.addEventListener('click', async function() {
            if (!confirm('üö® ARE YOU SURE? This will send an EMERGENCY ALERT to all security personnel!')) {
                return;
            }
            
            try {
                // Get current location for SOS
                const position = await getCurrentPosition();
                
                const sosData = {
                    guardId: GUARD_ID,
                    guardName: guardNameEl.textContent,
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                
                const response = await fetch(`${SERVER_URL}/api/sos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sosData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Visual feedback
                    sosBtn.innerHTML = 'üö® SOS SENT! HELP IS COMING!';
                    sosBtn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';
                    
                    // Vibrate phone if supported
                    if (navigator.vibrate) {
                        navigator.vibrate([500, 200, 500, 200, 500]);
                    }
                    
                    // Reset button after 10 seconds
                    setTimeout(() => {
                        sosBtn.innerHTML = 'üö® SOS EMERGENCY';
                        sosBtn.style.background = 'linear-gradient(135deg, #ff0000 0%, #cc0000 100%)';
                    }, 10000);
                }
                
            } catch (error) {
                console.error('Error sending SOS:', error);
                alert('Failed to send SOS. Please try again.');
            }
        });
        
        // Install as PWA prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button (optional)
            setTimeout(() => {
                if (confirm('Install Fox Eye Guard as an app for easier access?')) {
                    deferredPrompt.prompt();
                }
            }, 3000);
        });
        
        // Initialize app
        init();
    </script>
</body>
</html>
